# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a complete Docker-based code-server setup that provides VS Code in a web browser. The project uses the `lscr.io/linuxserver/code-server` image with an integrated Caddy reverse proxy for authentication and SSL termination. It's designed to be completely self-contained and production-ready.

## Key Components

- **docker-compose.yaml**: Integrated orchestration with LinuxServer code-server and Caddy
- **hash-password.sh**: Simple password hash generator script
- **Caddyfile**: Caddy configuration with service worker bypass
- **code-server/**: Code-server data directory (includes workspace subdirectory)
- **.env.example**: Environment configuration template
- **.env**: User environment configuration file (gitignored)

## Quick Setup

### Initial Setup
```bash
# Copy environment template
cp .env.example .env

# Generate password hash
./hash-password.sh "your-password"

# Edit .env with your values including the generated hash
# Start all services
docker-compose up -d
```

### Common Commands
```bash
# View logs for all services
docker-compose logs -f

# View logs for specific service
docker-compose logs -f code-server
docker-compose logs -f caddy

# Restart services
docker-compose restart

# Stop all services
docker-compose down

# Update images
docker-compose pull && docker-compose up -d

# Access container shell
docker-compose exec code-server bash
```

## Architecture

The setup uses an integrated containerized architecture:
- **code-server**: LinuxServer code-server container (internal authentication disabled)
- **caddy**: Integrated Caddy reverse proxy with Basic Auth and service worker bypass
- **network**: Internal Docker bridge network (`code-server-network`)
- **security**: Environment-based authentication with bcrypt password hashing

## Configuration

### Environment Variables (.env)
- `DOMAIN`: Domain name for the service (default: code-server.localhost)
- `HTTP_PORT`: External HTTP port mapping (default: 80)
- `HTTPS_PORT`: External HTTPS port mapping (default: 443)
- `AUTH_USERNAME`: Basic auth username (default: admin)
- `AUTH_PASSWORD_HASH`: Bcrypt hash of password (generated by hash-password.sh)
- `SUDO_PASSWORD`: Password for sudo commands within code-server

### Docker Environment
- `PASSWORD=`: Disables code-server's built-in authentication (empty value)
- `SUDO_PASSWORD=${SUDO_PASSWORD}`: Enables sudo with specified password
- `PUID=1000`, `PGID=1000`: Sets container user permissions
- `TZ=Asia/Seoul`: Timezone configuration
- `PROXY_DOMAIN=${DOMAIN}`: Sets proxy domain for LinuxServer image
- Config mounted to `/config` (LinuxServer standard)
- Workspace mounted to `/config/workspace`
- Docker socket mounted for Docker-in-Docker support
- Exposes port 8443 internally

### Caddy Configuration (Critical for Service Workers)
The Caddy configuration uses environment variables and includes special handling for service workers:

```caddy
{$DOMAIN} {
    route {
        # Service worker and static files bypass auth (CRITICAL)
        @bypass path_regexp ^/stable-.*
        reverse_proxy @bypass code-server:8443

        # All other requests require Basic Auth
        basic_auth {
            {$AUTH_USERNAME} {$AUTH_PASSWORD_HASH}
        }

        reverse_proxy code-server:8443
    }
}
```

## Known Issues & Solutions

### Service Worker 401 Errors
**Problem**: VS Code service workers fail to load with 401 errors when using Basic Auth
**Solution**: Use `route` directive with `@bypass path_regexp ^/stable-.*` to allow service worker scripts to bypass authentication

### WebSocket Connection Issues
**Problem**: WebSocket close with status code 1006
**Solution**: Use `route` directive for proper request handling. Caddy v2 supports WebSocket automatically without additional configuration. The route directive ensures authentication bypass rules are processed before basic auth.

### Authentication Strategy
- **Don't use**: code-server's built-in auth (causes service worker issues)
- **Use**: Caddy Basic Auth with selective path bypassing and environment variables
- **Setup**: Use `./hash-password.sh` script for secure password configuration

## Setup Instructions

### For New Deployments
1. Copy `.env.example` to `.env`
2. Run `./hash-password.sh "your-password"` to generate password hash
3. Edit `.env` with your domain, username, and generated password hash
4. Run `docker-compose up -d` to start services
5. Access via configured domain

### For Production Deployments
1. Set `DOMAIN` to your actual domain name in `.env`
2. Configure `HTTP_PORT` and `HTTPS_PORT` as needed
3. Ensure domain points to your server for Let's Encrypt
4. Use strong passwords via the hash-password script

## Troubleshooting

1. **Service Worker Errors**: Check that `/stable-*/static/*` paths are accessible without auth
2. **401 on Static Files**: Verify Caddy route configuration and restart services
3. **Connection Issues**: Check `docker-compose logs -f` for both services
4. **Permission Issues**: Ensure proper file ownership (1000:1000) in mounted volumes
5. **SSL Issues**: Check certificate paths in .env or use auto HTTPS
